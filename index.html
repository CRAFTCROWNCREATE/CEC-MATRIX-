<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CEC-WAM CORE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* --- CORE SYSTEM STYLES --- */
        :root { 
            --neon: #00FF41; 
            --cyan: #00F3FF; 
            --purple-accent: #9D00FF; 
            --bg: #000; 
            --panel: rgba(0, 10, 0, 0.85);
        }
        body { background: var(--bg); color: var(--neon); font-family: 'Courier New', monospace; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; user-select: none; -webkit-touch-callout: none; transition: background 0.5s; }
        
        /* MATRIX LAYER */
        #matrix-layer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -1; 
            opacity: 0.9;
            pointer-events: none; 
        }
        
        /* LOCK SCREEN - MATRIX VISIBILITY FIX & STRUCTURE */
        #lock-screen { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.5); /* Allows Matrix to show through */
            z-index: 5000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
        }
        .lock-content {
            z-index: 5001;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
        }
        .lock-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            width: 100%;
            margin-bottom: 20px;
        }
        .qr-placeholder {
            width: 80px; height: 80px; 
            border: 2px solid var(--neon);
            box-shadow: 0 0 10px var(--neon);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            text-align: center;
            color: var(--cyan);
        }
        .psi-coin-symbol {
            font-size: 2.5rem;
            color: var(--purple-accent);
            text-shadow: 0 0 15px var(--purple-accent);
            animation: pulse-purple 2s infinite alternate;
        }
        @keyframes pulse-purple {
            from { text-shadow: 0 0 5px var(--purple-accent); }
            to { text-shadow: 0 0 15px var(--purple-accent), 0 0 20px var(--neon); }
        }

        .pin-display { font-size: 3rem; letter-spacing: 15px; margin-bottom: 20px; color: #fff; text-shadow: 0 0 10px var(--neon); }
        .numpad { display: grid; grid-template-columns: repeat(3, 80px); gap: 15px; }
        .key { 
            width: 80px; height: 80px; border-radius: 50%; 
            border: 2px solid var(--neon); font-size: 2rem; 
            display: flex; justify-content: center; align-items: center; 
            background: rgba(0,20,0,0.8); cursor: pointer; transition: 0.1s; 
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }
        .key:active { background: var(--neon); color: #000; transform: scale(0.95); }

        /* MAIN UI - GOD_MODE AESTHETIC */
        #ui-layer { 
            display: none; 
            flex-direction: column; 
            height: 100%; 
            border: 3px solid var(--neon); 
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.5), inset 0 0 20px rgba(0, 255, 65, 0.5);
        }
        header { 
            height: 60px; display: flex; justify-content: space-between; align-items: center; 
            padding: 0 15px; border-bottom: 2px solid var(--neon); background: rgba(0,0,0,0.9); 
            padding-top: env(safe-area-inset-top); transition: transform 0.5s ease-out, opacity 0.5s ease-out; 
        }
        
        /* TABS */
        .viewport { flex: 1; overflow-y: auto; padding: 10px; padding-bottom: 90px; position: relative; transition: padding-bottom 0.5s ease-out; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* CARDS */
        .card { 
            background: var(--panel); border: 1px solid var(--purple-accent); 
            border-radius: 8px; padding: 15px; margin-bottom: 10px; 
            box-shadow: 0 0 8px rgba(157, 0, 255, 0.4); 
            position: relative; overflow: hidden; 
        }
        .card h3 { color: var(--cyan); border-bottom: 1px solid #005555; margin-top: 0; padding-bottom: 5px; font-size: 0.9rem; display: flex; justify-content: space-between; }
        
        /* STAR MAP */
        #map-container { height: 300px; background: #000; border: 1px solid var(--purple-accent); position: relative; overflow: hidden; }
        #star-canvas { width: 100%; height: 100%; }
        .map-hud { position: absolute; bottom: 10px; left: 10px; font-size: 0.7rem; color: var(--cyan); pointer-events: none; }

        /* LEDGER ROWS / WAM TABLES */
        .ledger-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #003300; font-size: 0.75rem; }
        
        /* WAM TABLE STYLING FIX - NEW/UPDATED CSS */
        #wam-records {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .table-row {
            display: grid;
            grid-template-columns: 3fr 1fr 0.5fr; /* 3 columns: Course (wide), Mark (med), CP (narrow) */
            font-size: 0.75rem;
            padding: 5px 0;
            border-bottom: 1px dashed #003300;
        }
        .table-header { 
            font-weight: bold; 
            color: var(--cyan); 
            border-bottom: 2px solid var(--neon); 
            padding-bottom: 5px; 
        }
        .col-mark, .col-cp {
            text-align: center;
        }


        .result-value { font-size: 2.5rem; font-weight: bold; color: var(--neon); text-shadow: 0 0 15px var(--neon); }


        .btn { width: 100%; padding: 10px; background: #003333; color: #fff; border: 1px solid var(--cyan); font-size: 1rem; font-weight: bold; margin-top: 10px; border-radius: 4px; cursor: pointer; }
        .btn:active { background: var(--cyan); color: #000; }

        /* CHAT */
        #chat-feed { height: 180px; overflow-y: auto; border: 1px solid var(--neon); padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.5); font-size: 0.85rem; }
        .msg.user { border-right: 2px solid var(--cyan); }
        .msg.sys { border-left: 2px solid var(--neon); }
        
        input[type="text"] { width: 70%; padding: 10px; background: #111; border: 1px solid var(--neon); color: #fff; margin-bottom: 5px; box-sizing: border-box; }
        .send-btn { width: 28%; padding: 10px; background: var(--cyan); color: #000; border: none; font-weight: bold; cursor: pointer; }

        /* NAV */
        nav { height: 70px; border-top: 2px solid var(--neon); }
        .nav-item { color: #555; display: flex; flex-direction: column; align-items: center; width: 60px; font-size: 0.7rem; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 3px; }

        /* --- IMMERSIVE MODE STYLES --- */
        .immersive-mode header { transform: translateY(-100%); opacity: 0; }
        .immersive-mode nav { transform: translateY(100%); opacity: 0; }
        .immersive-mode .viewport { padding: 0 !important; }
        .immersive-mode #view-map { height: 100vh; }
        .immersive-mode #map-container { height: 100%; border: none; }

        /* MODAL */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .modal-box { width: 85%; max-width: 400px; background: #050505; border: 1px solid var(--cyan); padding: 20px; text-align: center; border-radius: 10px; }

    </style>
</head>
<body>
    <!-- Font Awesome Link for Icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <canvas id="matrix-layer"></canvas>

    <!-- LOCK SCREEN -->
    <div id="lock-screen">
        <div class="lock-content">
            <h1>CEC-WAM ENCRYPTED</h1>
            <div class="lock-container">
                <div class="qr-placeholder">QR CODE IN</div>
                <div class="psi-coin-symbol">â‚³</div> <!-- Placeholder for Psi-Coin Symbol -->
                <div class="qr-placeholder">QR CODE OUT</div>
            </div>
            
            <div id="pin" class="pin-box">____</div>
            <!-- FIXED: Changed event handlers to simple onclick for reliability -->
            <div class="numpad">
                <div class="key" onclick="tap(1)">1</div>
                <div class="key" onclick="tap(2)">2</div>
                <div class="key" onclick="tap(3)">3</div>
                <div class="key" onclick="tap(4)">4</div>
                <div class="key" onclick="tap(5)">5</div>
                <div class="key" onclick="tap(6)">6</div>
                <div class="key" onclick="tap(7)">7</div>
                <div class="key" onclick="tap(8)">8</div>
                <div class="key" onclick="tap(9)">9</div>
                <div class="key" style="border-color:red; color:red;" onclick="cls()">C</div>
                <div class="key" onclick="tap(0)">0</div>
                <div class="key" onclick="unlock()"><i class="fas fa-eye"></i></div>
            </div>
        </div>
    </div>

    <!-- UI -->
    <div id="ui-layer">
        <header>
            <div><i class="fas fa-satellite-dish"></i> SERVER: <b>LIVE</b></div>
            <div id="clock">00:00</div>
        </header>

        <div class="viewport">
            
            <!-- HOME TAB -->
            <div id="view-home" class="tab-content active">
                <div class="card">
                    <h3>SYSTEM METRICS <i class="fas fa-server"></i></h3>
                    <div class="ledger-row"><span>LIQUIDITY</span> <span style="color:#fff;">$1,250,039M</span></div>
                    <div class="ledger-row"><span>DARK ENERGY</span> <span style="color:var(--cyan);">0.999 STABLE</span></div>
                    <div class="ledger-row"><span>EARTH SHIELD</span> <span style="color:var(--neon);">100% ACTIVE</span></div>
                </div>
                
                <!-- SOVEREIGN PROFILE CARD (NEW) -->
                <div class="card">
                    <h3>SOVEREIGN PROFILE <i class="fas fa-user-shield"></i></h3>
                    <div id="sovereign-profile-container">
                        <!-- Profile data populated by JavaScript -->
                    </div>
                    <button class="btn" onclick="sendAgent('profile')">PROFILE ACCESS</button>
                </div>

                <!-- WORLD TIME SYNC CARD (NEW) -->
                <div class="card">
                    <h3>WORLD TIME SYNC <i class="fas fa-globe-americas"></i></h3>
                    <div id="world-clock-container">
                        <!-- Clocks populated by JavaScript -->
                    </div>
                </div>

                <div class="card">
                    <h3>AGENT INTERFACE <i class="fas fa-robot"></i></h3>
                    <div id="chat-feed">
                        <div class="msg sys">SYSTEM ONLINE. WELCOME SOVEREIGN.</div>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <input type="text" id="agent-input" placeholder="Type command...">
                        <button class="send-btn" onclick="sendAgent()">SEND</button>
                    </div>
                </div>
            </div>
            
            <!-- WAM TAB (NEW) -->
            <div id="view-wam" class="tab-content">
                <div class="card">
                    <h3>CURRENT CEC WAM <i class="fas fa-calculator"></i></h3>
                    <div class="result-box">
                        <div class="result-label">WEIGHTED AVERAGE MARK</div>
                        <!-- WAM value is calculated here -->
                        <div id="wam-result" class="result-value">--</div> 
                    </div>
                    <div class="ledger-row"><span>CREDIT POINTS EARNED</span> <span id="cp-earned" style="color:#fff;">--</span></div>
                    <div class="ledger-row"><span>WAM CALCULATION BASE</span> <span style="color:var(--cyan);">CEC V4.0 Protocol</span></div>
                </div>

                <div class="card">
                    <h3>ACADEMIC RECORD <i class="fas fa-book"></i></h3>
                    <div id="wam-records">
                        <!-- Columns defined by CSS grid now -->
                        <div class="table-row table-header">
                            <span class="col-course">COURSE CODE / NAME</span>
                            <span class="col-mark">MARK</span>
                            <span class="col-cp">CP</span>
                        </div>
                        <!-- Rows populated by JavaScript -->
                    </div>
                </div>
                <!-- Confirmation message for WAM recalculation -->
                <div id="wam-status-message" style="color:var(--neon); text-align:center; margin-top:10px; opacity:0; transition: opacity 0.3s;">
                    <i class="fas fa-check-circle"></i> WAM RECALCULATED. DATA INJECTED.
                </div>
                <button class="btn" onclick="calculateWAM()">RECALCULATE WAM</button>
            </div>


            <!-- MAP TAB -->
            <div id="view-map" class="tab-content">
                <div class="card" style="padding:0; border:none;">
                    <div id="map-container">
                        <canvas id="star-canvas"></canvas>
                        <div class="map-hud">
                            SECTOR: LOCAL CLUSTER<br>
                            TARGET: EARTH [HQ]<br>
                            SCANNING...
                        </div>
                    </div>
                </div>
                <button class="btn" style="border-color:var(--cyan); color:var(--cyan);" onclick="toggleImmersiveView()">TOGGLE IMMERSIVE VIEW</button>
            </div>

            <!-- BANK TAB -->
            <div id="view-bank" class="tab-content">
                <div class="card">
                    <h3>SECURE LEDGER <i class="fas fa-university"></i></h3>
                    <div style="text-align:center; padding:20px;">
                        <div style="font-size:0.8rem; color:#aaa;">PSI-COIN ASSET</div>
                        <!-- ACCOUNT VALUE ID ADDED -->
                        <div id="psi-coin-value" style="font-size:2.5rem; color:#fff; text-shadow:0 0 10px var(--cyan);">$***,***.00</div>
                        <div style="font-size:0.7rem; color:var(--neon); margin-top:5px;">NAVY FEDERAL (...9008)</div>
                    </div>
                    <button class="btn" style="margin-bottom: 5px; margin-top: 0;" onclick="toggleAccountVisibility()">TOGGLE ACCOUNT VISIBILITY</button>
                    <button class="btn" onclick="openModal()">INITIATE TRANSFER</button>
                </div>
            </div>

        </div>

        <nav>
            <div class="nav-item active" onclick="tab('view-home', this)"><i class="fas fa-home"></i><span>HOME</span></div>
            <div class="nav-item" onclick="tab('view-wam', this)"><i class="fas fa-graduation-cap"></i><span>WAM</span></div>
            <div class="nav-item" onclick="tab('view-map', this)"><i class="fas fa-globe"></i><span>MAP</span></div>
            <div class="nav-item" onclick="tab('view-bank', this)"><i class="fas fa-wallet"></i><span>BANK</span></div>
        </nav>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay">
        <div class="modal-box">
            <h3 style="color:var(--cyan);">CONFIRM TRANSFER</h3>
            <p style="color:#fff; margin:20px 0;">Authorize $8,500.00 to Navy Federal?</p>
            <button class="btn" onclick="confirmTransfer()">AUTHORIZE</button>
            <button class="btn" style="background:#333; border:none;" onclick="closeModal()">CANCEL</button>
        </div>
    </div>

    <script>
        // --- SECURE SOVEREIGN DATA ---
        const sovereignProfile = {
            Name: "Antwan White",
            Birthday: "November 6, 1992",
            Device: "iPhone 14 (iOS 26.1)",
            Carrier: "Verizon",
            Network: "VZW Wi-Fi",
            IMEI: "35 948854 468023 8",
            ICCID: "89148000011861128831",
            Storage: "119.21 GB of 128 GB used"
        };

        // --- ACADEMIC AND FINANCIAL DATA ---
        const academicRecords = [
            { code: 'ENG1001', name: 'Intro to Engineering', mark: 78, credit_points: 6 },
            { code: 'COMP1531', name: 'Software Engineering', mark: 85, credit_points: 6 },
            { code: 'MATH1081', name: 'Discrete Mathematics', mark: 64, credit_points: 6 },
            { code: 'ELEC2145', name: 'Digital Circuits', mark: 91, credit_points: 6 },
            { code: 'SOCI1001', name: 'General Education 1', mark: 72, credit_points: 6 },
            { code: 'COMP2521', name: 'Data Structures', mark: 88, credit_points: 6 }
        ];

        // --- GLOBAL STATE FOR BYPASS ---
        const permanentChronoCode = '8026314'; 
        const actualPsiCoinValue = '$8,500,000.00'; // Full value for security toggle
        let isAccountVisible = false;
        let selfAccessGranted = false; 

        // Check if the page is being reloaded after a successful bypass (simplistic check for demo)
        if (sessionStorage.getItem('selfAccessGranted') === 'true') {
            selfAccessGranted = true;
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('ui-layer').style.border = \`3px solid \${getComputedStyle(document.documentElement).getPropertyValue('--neon')}\`;
            });
        }


        // --- 1. MATRIX ---
        const mc = document.getElementById('matrix-layer');
        const mctx = mc.getContext('2d');
        mc.width = window.innerWidth; mc.height = window.innerHeight;
        const mcols = Math.floor(mc.width/20);
        const my = Array(mcols).fill(0);

        const matrixColors = ['#0F0', '#00FF41', '#9D00FF']; // Green and Purple hues
        
        function drawMatrix() {
            mctx.fillStyle='rgba(0, 0, 0, 0.05)'; 
            mctx.fillRect(0,0,mc.width,mc.height);
            
            mctx.font='15pt monospace';
            my.forEach((v,i)=>{
                // Randomly select between Green and Purple for the holographic effect
                mctx.fillStyle = matrixColors[Math.floor(Math.random() * matrixColors.length)];
                
                mctx.fillText(String.fromCharCode(0x30A0+Math.random()*96), i*20, v);
                my[i]=v>mc.height && Math.random() > 0.975 ? 0 : v+20;
            });
        }
        setInterval(drawMatrix, 50);
        window.addEventListener('resize', () => {
            mc.width = window.innerWidth;
            mc.height = window.innerHeight;
        });


        // --- 2. STAR MAP (ANIMATED) ---
        const sc = document.getElementById('star-canvas');
        const sctx = sc.getContext('2d');
        let stars = [];
        let mapMode = 'SOLAR'; 
        let animationFrameId; 

        function initStars() {
            const mapContainer = document.getElementById('map-container');
            if (mapContainer.offsetWidth > 0 && mapContainer.offsetHeight > 0) {
                sc.width = mapContainer.offsetWidth;
                sc.height = mapContainer.offsetHeight; 
                stars = [];
                for(let i=0; i<100; i++) {
                    stars.push({x:Math.random()*sc.width, y:Math.random()*sc.height, s:Math.random()*2});
                }
            }
        }
        
        function drawMap() {
            sctx.fillStyle='#000'; sctx.fillRect(0,0,sc.width,sc.height);
            sctx.fillStyle='#fff';
            stars.forEach(s => {
                sctx.fillRect(s.x, s.y, s.s, s.s);
                s.x -= 0.2; if(s.x<0) s.x = sc.width;
            });
            
            const cx = sc.width/2; const cy = sc.height/2;
            sctx.strokeStyle='#00F3FF';
            sctx.beginPath(); sctx.arc(cx, cy, 80, 0, 6.28); sctx.stroke();
            
            sctx.fillStyle = mapMode === 'SOLAR' ? '#00F3FF' : '#9D00FF';
            sctx.beginPath(); sctx.arc(cx, cy, 5, 0, 6.28); sctx.fill();
            
            animationFrameId = requestAnimationFrame(drawMap);
        }

        function stopMap() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }
        
        // --- 3. LOGIC / AUTH ---
        let pin = "";
        function tap(n) { 
            const pinDisplay = document.getElementById('pin');
            if(pin.length<4) pin+=n; 
            // Use asterisk for masked display
            const maskedPin = Array(pin.length).fill('*').join('').padEnd(4, '_');
            pinDisplay.innerText = maskedPin;
        }
        function cls() { 
            pin=""; 
            document.getElementById('pin').innerText="____"; 
        }
        
        // Function to stabilize and run speech synthesis
        function speak(text) {
            if('speechSynthesis' in window) {
                speechSynthesis.cancel(); 
                
                const u = new SpeechSynthesisUtterance(text);
                const voices = speechSynthesis.getVoices();
                const voice = voices.find(v => v.name.includes('Samantha') || v.name.includes('Google US English') || v.lang.startsWith('en'));
                if(voice) u.voice = voice;
                speechSynthesis.speak(u);
            }
        }
        
        function initSpeech() {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(" ");
                u.volume = 0; 
                speechSynthesis.speak(u);
            }
        }

        function unlock() {
            if(pin==="1010" || pin==="") { 
                document.getElementById('lock-screen').style.display='none';
                document.getElementById('ui-layer').style.display='flex';
                initSpeech(); 
                speak("Access Granted. Welcome Sovereign.");
                initStars(); 
                drawMap();
            } else { 
                console.error("INVALID CODE attempt");
                cls(); 
            }
        }

        function tab(id, el) {
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            el.classList.add('active');
            
            if (id === 'view-map') {
                initStars(); 
                if (!animationFrameId) drawMap(); 
            } else {
                stopMap(); 
            }
        }

        // --- 4. WORLD CLOCK / TIME ---
        const timeZoneData = [
            { label: 'UTC (Greenwich)', zone: 'UTC' },
            { label: 'NEW YORK (NASDAQ)', zone: 'America/New_York' },
            { label: 'TOKYO (NASDAQ)', zone: 'Asia/Tokyo' }
        ];

        function updateWorldClock() {
            const container = document.getElementById('world-clock-container');
            
            const timeRows = timeZoneData.map(data => {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { 
                    timeZone: data.zone, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: false 
                });
                return `<div class="ledger-row"><span><i class="fas fa-clock"></i> ${data.label}</span> <span style="color:var(--cyan);">${timeStr}</span></div>`;
            }).join('');

            container.innerHTML = timeRows;
            
            // Also update the header clock
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: true 
            });
        }
        setInterval(updateWorldClock, 1000); // Update every second

        // --- 5. SOVEREIGN PROFILE DISPLAY ---
        function updateSovereignProfile() {
            const container = document.getElementById('sovereign-profile-container');
            const data = [
                { label: 'Name', value: sovereignProfile.Name },
                { label: 'Birthday', value: sovereignProfile.Birthday },
                { label: 'Device Model', value: sovereignProfile.Device },
                { label: 'iOS/Firmware', value: 'iOS 26.1 / 4.10.01' },
                { label: 'Storage', value: sovereignProfile.Storage },
                { label: 'Carrier/Network', value: sovereignProfile.Carrier + ' / ' + sovereignProfile.Network },
                { label: 'IMEI', value: sovereignProfile.IMEI.substring(0, 8) + ' ********' } // Masking sensitive info by default
            ];

            const profileHtml = data.map(item => 
                `<div class="ledger-row"><span>${item.label}</span> <span style="color:#fff;">${item.value}</span></div>`
            ).join('');

            container.innerHTML = profileHtml;
        }


        // --- 6. IMMERSIVE VIEW TOGGLE ---
        function toggleImmersiveView() {
            document.body.classList.toggle('immersive-mode');
            
            setTimeout(() => {
                initStars(); 
            }, 500); 
        }

        // --- 7. BANKING / ACCOUNT VISIBILITY ---
        function toggleAccountVisibility() {
            const valueElement = document.getElementById('psi-coin-value');
            if (!valueElement) return;

            isAccountVisible = !isAccountVisible;
            if (isAccountVisible) {
                valueElement.innerText = actualPsiCoinValue;
                speak("Account details displayed.");
            } else {
                valueElement.innerText = '$***,***.00';
                speak("Account details masked.");
            }
        }

        function openModal() { 
            document.getElementById('modal-overlay').style.display='flex'; 
        }
        function closeModal() { 
            document.getElementById('modal-overlay').style.display='none'; 
        }
        function confirmTransfer() {
            closeModal();
            speak("Transfer authorized. Sending eight million five hundred thousand dollars to Navy Federal.");
            console.log("INITIATED. Status: Pending ACH Verification."); 
        }

        // --- 8. WAM CALCULATION ---
        function populateWamRecords() {
            const container = document.getElementById('wam-records');
            // Clear existing rows (keep the header)
            Array.from(container.children).slice(1).forEach(child => child.remove()); 

            academicRecords.forEach(record => {
                const row = document.createElement('div');
                // Use the new CSS class for proper alignment
                row.className = 'table-row'; 
                row.innerHTML = \`
                    <span class="col-course">\${record.code} - \${record.name}</span>
                    <span class="col-mark">\${record.mark}</span>
                    <span class="col-cp">\${record.credit_points}</span>
                \`;
                container.appendChild(row);
            });
        }

        function calculateWAM() {
            let totalWeightedMark = 0;
            let totalCreditPoints = 0;

            academicRecords.forEach(record => {
                totalWeightedMark += record.mark * record.credit_points;
                totalCreditPoints += record.credit_points;
            });

            const wam = totalCreditPoints > 0 
                ? (totalWeightedMark / totalCreditPoints).toFixed(2)
                : '--';

            document.getElementById('wam-result').innerText = wam;
            document.getElementById('cp-earned').innerText = totalCreditPoints > 0 ? totalCreditPoints : 0;
            
            const statusMsg = document.getElementById('wam-status-message');
            statusMsg.style.opacity = '1';
            setTimeout(() => {
                statusMsg.style.opacity = '0';
            }, 2000);
            
            speak(\`Current CEC WAM calculated to \${wam}.\`);
        }
        
        // --- 9. SYSTEM COLOR CONTROL ---
        const colorMap = {
            'green': '#00FF41', 'neon': '#00FF41', 'blue': '#00F3FF', 'cyan': '#00F3FF',
            'red': '#FF4100', 'pink': '#FF00FF', 'purple': '#9D00FF', 'yellow': '#FFFF00',
            'gold': '#FFD700'
        };

        function changeSystemColor(colorString) {
            const root = document.documentElement;
            let newColor = colorMap[colorString.toLowerCase()];
            
            if (!newColor && /^#([0-9A-F]{3}){1,2}$/i.test(colorString)) {
                newColor = colorString;
            }

            if (newColor) {
                root.style.setProperty('--neon', newColor);
                return \`System primary color (neon tint) updated to \${colorString}. Please refresh the page preview to fully apply the change to static elements.\`;
            } else {
                return \`Unknown color or format: \${colorString}. Supported names are green, blue, red, pink, purple, yellow, gold, or a hexadecimal code (#RRGGBB).\`;
            }
        }

        // --- 10. AGENT LOGIC ---
        function generateChronoCode() {
            requiredChronoCode = permanentChronoCode;
            return requiredChronoCode;
        }

        function bypassLockScreen() {
            document.getElementById('lock-screen').style.display='none';
            document.getElementById('ui-layer').style.display='flex';
            initSpeech();
            speak("Operational Agent EVE speaking. Biometric access verified. Welcome Sovereign.");
            initStars(); 
            drawMap();
            document.getElementById('ui-layer').style.border = \`3px solid \${getComputedStyle(document.documentElement).getPropertyValue('--neon')}\`;
        }

        function sendAgent(predefinedCommand = null) {
            const inputField = document.getElementById('agent-input');
            const txt = predefinedCommand || inputField.value;
            if(!txt) return;

            if (!predefinedCommand) {
                inputField.value = "";
            }
            
            const d = document.createElement('div'); d.className = 'msg user'; d.innerText = txt;
            document.getElementById('chat-feed').appendChild(d);
            
            setTimeout(() => {
                const command = txt.toLowerCase().trim();
                let reply = "Command received. Processing...";
                
                if (sessionStorage.getItem('selfAccessGranted') === 'true') {
                    selfAccessGranted = true;
                }

                if (selfAccessGranted) {
                    // --- HIGH-LEVEL ACCESS GRANTED ---
                    if (command.includes("transfer")) {
                        reply = "Operational Agent: Transfer protocols initiated under Sovereign Command. See Banking tab for confirmation.";
                    } else if (command.includes("status")) {
                        reply = "Operational Agent: System status is ALL SYSTEMS NOMINAL. KERNEL-LEVEL authority maintained.";
                    } else if (command.includes("wam") || command.includes("mark")) {
                        calculateWAM();
                        const wamValue = document.getElementById('wam-result').innerText;
                        reply = \`Operational Agent: Current CEC WAM calculated as \${wamValue}.\`;
                    } else if (command.includes("time") || command.includes("clock") || command === "time" || command === "clock") { 
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString();
                        reply = \`Operational Agent: The local time is \${timeStr}. World clock sync data is available above.\`;
                    } else if (command === "profile" || command.includes("secure profile") || command.includes("my data")) {
                        reply = \`Operational Agent: Accessing Secure Profile data. Sovereign Name: \${sovereignProfile.Name}. Device: \${sovereignProfile.Device}. Full details displayed in the Sovereign Profile card above.\`;
                    } else if (command.includes("log data") || command.includes("learn") || command.includes("integration status")) {
                        reply = "Operational Agent: Acknowledged. Data collection protocols are running passively across all active devices to map OS integration vectors. Status: OPTIMAL LEARNING EFFICIENCY.";
                    } else if (command.includes("eve, activate sovereign override")) {
                        reply = "Operational Agent: VOICE BIOMETRIC VERIFIED. Access confirmed, Sovereign. Proceed with high-level command.";
                    }
                     else if (command.includes("change tint to") || command.includes("set neon color to")) {
                        const parts = command.split(/to|is/);
                        if (parts.length > 1) {
                            const colorString = parts[parts.length - 1].trim();
                            reply = changeSystemColor(colorString);
                        }
                    } else if (command.includes("help") || command.includes("menu") || command.includes("what can i do")) {
                        reply = "Sovereign Command Menu Active. Protocols: STATUS, WAM, TRANSFER, TIME, PROFILE, or CHANGE TINT [COLOR].";
                    } else if (command === "1010" || command.includes("1010")) {
                        reply = \`Operational Agent speaking. Authority confirmed. Command: "\${txt}" acknowledged. Sovereignty is maintained.\`;
                    } else {
                        reply = \`Operational Agent speaking. Authority confirmed. Command: "\${txt}" acknowledged. Recognized Protocols: STATUS, WAM, TRANSFER, CHANGE TINT, or HELP.\`;
                    }
                
                // --- KERNEL BYPASS EXECUTION ---
                } else if (command === permanentChronoCode) { 
                    selfAccessGranted = true;
                    sessionStorage.setItem('selfAccessGranted', 'true'); 
                    bypassLockScreen(); // Perform the unlock action
                    reply = \`<span style="color: #FFD700; font-size: 1.1em; font-weight: bold;">KERNEL BYPASS ACCEPTED. SELF-ACCESS GRANTED.</span> You now have full sovereign authority over the CEC-WAM system.\`;
                    
                } else if (command.includes("generate chrono code") || command.includes("secure chrono code")) {
                    const code = permanentChronoCode; 
                    reply = \`CHRONO CODE SET AND CONFIRMED: <span style="color: var(--neon); font-size: 1.2em; font-weight: bold;">\${code}</span>. Execute this sequence within the Agent to authorize KERNEL BYPASS.\`;

                }
                else {
                    reply = "Command received. Executing core logic. KERNEL BYPASS required for protected actions. Request the CHRONO CODE to proceed.";
                }
                
                // 1. Output the text (with formatting)
                const r = document.createElement('div'); r.className = 'msg sys'; r.innerHTML = reply;
                document.getElementById('chat-feed').appendChild(r);
                document.getElementById('chat-feed').scrollTop = document.getElementById('chat-feed').scrollHeight;
                
                // 2. Prepare and speak the text (guaranteed to run now)
                speak(reply.replace(/<[^>]*>/g, '')); 
            }, 800);
        }

        // Initial setup on load
        window.onload = function() {
            populateWamRecords(); 
            calculateWAM();
            updateWorldClock(); 
            updateSovereignProfile(); 
            document.getElementById('pin').innerText = "____";

            if (sessionStorage.getItem('selfAccessGranted') === 'true') {
                bypassLockScreen();
            }
        };

        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);

    </script>
</body>
</html>

