<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-web-app-status-bar-style" content="black-translucent">
    <title>CEC-CDL ALPHA NODE</title>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <!-- Three.js Library for 3D Visualization (Pillar 3 Readiness) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script type="module">
        // --- FIREBASE IMPORTS (Pillar 1: Persistence & Auth) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables are available in the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;

        // --- CORE LOGIC FUNCTIONS (MOVED UP FOR ASYNC ACCESS) ---

        window.populateWamRecords = function() {
            const container = document.getElementById('wam-records');
            if (!container || container.children.length === 0) return;
            
            Array.from(container.children).slice(1).forEach(child => child.remove()); 

            window.academicRecords.forEach(record => {
                const row = document.createElement('div');
                row.className = 'table-row'; 
                row.innerHTML = `
                    <span class="col-course">${record.code} - ${record.name}</span>
                    <span class="col-mark">${record.mark}</span>
                    <span class="col-cp">${record.credit_points}</span>
                `;
                container.appendChild(row);
            });
        }

        window.calculateWAM = function() {
            let totalWeightedMark = 0;
            let totalCreditPoints = 0;

            window.academicRecords.forEach(record => {
                totalWeightedMark += record.mark * record.credit_points;
                totalCreditPoints += record.credit_points;
            });

            const wam = totalCreditPoints > 0 
                ? (totalWeightedMark / totalCreditPoints).toFixed(2)
                : '--';

            document.getElementById('wam-result').innerText = wam;
            document.getElementById('cp-earned').innerText = totalCreditPoints > 0 ? totalCreditPoints : 0;
            
            const statusMsg = document.getElementById('wam-status-message');
            if (statusMsg) {
                statusMsg.style.opacity = '1';
                setTimeout(() => {
                    statusMsg.style.opacity = '0';
                }, 2000);
            }
        }
        
        // --- END CORE LOGIC FUNCTIONS ---


        // Initialize Firebase and Authentication
        async function initializeFirebase() {
            try {
                setLogLevel('error'); 
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Successful. User ID:", userId);
                        initDataListeners();
                        window.db = db;
                        window.auth = auth;
                        window.userId = userId; 
                        window.initializeApp = initializeApp; 
                        
                        if (sessionStorage.getItem('selfAccessGranted') === 'true') {
                            window.bypassLockScreen(); 
                        }
                        checkAndLogInitialUpgradeCost();
                    } else {
                        console.log("Firebase Auth State: Signed out.");
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // NEW: Log network status failure
                window.displayAlert("NETWORK ALERT: Firebase initialization failed. Check Wi-Fi/data connection.", "red");
            }
        }
        
        // --- FINANCIAL LOGIC ---
        const INITIAL_UPGRADE_COST = 27500.00; // Phase I cost in Psi-Coin

        async function checkAndLogInitialUpgradeCost() {
            if (!window.db || !window.userId) return;

            const ledgerRef = doc(window.db, `artifacts/${appId}/users/${userId}/ledger`, 'financial_summary');
            
            if (sessionStorage.getItem('upgrade_cost_logged') === 'true') {
                return;
            }

            try {
                await setDoc(ledgerRef, {
                    psiCoinSpent: INITIAL_UPGRADE_COST,
                    psiCoinAssetValue: 8500000.00 - INITIAL_UPGRADE_COST, // Subtract cost immediately
                    lastFinancialSync: new Date().toISOString(),
                    upgrade_cost_logged: true
                }, { merge: true });

                sessionStorage.setItem('upgrade_cost_logged', 'true');
                window.displayAlert("CEC-CDL ALPHA NODE ACTIVATED: 27,500 PSI-COIN EXPENDITURE LOGGED. QUANTUM PROCESSING INITIATED.", "magenta");
            } catch (e) {
                console.error("Error logging initial cost:", e);
            }
        }


        // --- DATA LISTENER SETUP (Pillar 1) ---
        function initDataListeners() {
            if (!db || !userId) return;

            const ledgerRef = doc(db, `artifacts/${appId}/users/${userId}/ledger`, 'financial_summary');
            onSnapshot(ledgerRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.ledgerData = data;
                    
                    if (data.psiCoinAssetValue !== undefined) {
                        window.actualPsiCoinValue = `$${data.psiCoinAssetValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                        if (window.isAccountVisible) {
                            document.getElementById('psi-coin-value').innerText = window.actualPsiCoinValue;
                        }
                        const spentAmount = data.psiCoinSpent || 0;
                        document.getElementById('psi-coin-spent').innerText = `$${spentAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                    }
                    
                    if (data.satelliteCredits) {
                        document.getElementById('sat-credits').innerText = `+ ${data.satelliteCredits} CR`;
                    }
                } else {
                    // Defaults will be set upon checkAndLogInitialUpgradeCost running
                }
            });

            const academicQuery = query(collection(db, `artifacts/${appId}/users/${userId}`, 'academic_records'));
            onSnapshot(academicQuery, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => records.push(doc.data()));
                window.academicRecords = records;
                // These functions are now defined earlier and globally accessible
                window.populateWamRecords(); 
                window.calculateWAM();
            });
        }
        
        // --- EXPORT GLOBAL FUNCTIONS FOR HTML ACCESS (Required for Modular JS) ---
        window.initializeFirebase = initializeFirebase;
        
    </script>
    <style>
        /* --- CORE SYSTEM STYLES (5D UPGRADE) --- */
        :root { 
            --neon: #00FF41; 
            --cyan: #00F3FF; 
            --magenta: #FF00FF; 
            --bg: #000; 
            /* NEW: Reduced opacity for more "see-through, pearlescent" panel look */
            --panel: rgba(0, 10, 20, 0.5); 
        }
        body { 
            background: var(--bg); 
            color: var(--neon); 
            font-family: 'Consolas', 'Courier New', monospace; 
            margin: 0; 
            height: 100vh; 
            /* FINAL CSS FIX: Prevent horizontal scrolling */
            overflow-x: hidden; 
            overflow-y: hidden;
            display: flex; 
            flex-direction: column; 
            user-select: none; 
            -webkit-touch-callout: none; 
            transition: background 0.5s; 
            align-items: center; 
            justify-content: center;
        }
        
        #perspective-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1500px; 
            max-width: 900px; 
        }

        /* MATRIX LAYER (BRIGHTNESS FIX) */
        #matrix-layer { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -1; 
            opacity: 0.95; 
            pointer-events: none; 
        }

        /* --- UI STYLING --- */
        #ui-layer {
            display: none; 
            flex-direction: column; 
            width: 95%; 
            height: 95%; 
            max-height: 95vh;
            background: rgba(0, 0, 0, 0.85); 
            border: 3px solid var(--neon); 
            box-shadow: 
                0 0 10px rgba(0, 255, 65, 0.5), 
                0 0 20px var(--cyan),           
                0 0 30px var(--magenta) inset;  
            border-image: linear-gradient(45deg, var(--neon), var(--cyan), var(--magenta)) 1;
            transform: rotateX(10deg); 
            position: relative;
        }
        
        /* HEADER/FRAME */
        header { 
            height: 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 15px; 
            font-size: 0.8rem;
            border-bottom: 1px solid var(--cyan);
            background: rgba(0,0,0,0.5);
            color: var(--cyan);
            text-shadow: 0 0 5px var(--cyan);
            position: relative;
        }
        
        /* New Global Alert Box */
        #global-alert {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 7000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        .alert-content {
            background: rgba(0, 50, 50, 0.9);
            border: 3px solid var(--magenta);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 30px var(--magenta);
            max-width: 80%;
        }
        .alert-content h2 {
            color: var(--neon);
            text-shadow: 0 0 5px var(--neon);
        }
        .alert-content p {
            color: var(--cyan);
            margin: 15px 0;
        }
        .alert-button {
            background: var(--magenta);
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
        }


        #lock-screen { 
            /* FINAL CRITICAL FIX: Use fixed position and vh/vw to prevent any background scrolling */
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            background: rgba(0, 0, 0, 0.75);
            z-index: 6000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            /* Prevents touch movement that tries to scroll the content underneath */
            touch-action: none; 
        }

        .lock-screen-title {
            height: 0;
            overflow: hidden;
            opacity: 0;
            margin: 0;
        }

        .auth-center-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 450px;
            padding: 20px; 
            background: rgba(0, 0, 0, 0.8); 
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }

        .control-panel {
            background: rgba(0, 10, 20, 0.9);
            border: 3px solid var(--magenta); 
            box-shadow: 0 0 20px var(--magenta);
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr; 
            gap: 10px;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 12px;
            margin-top: 20px; 
        }

        .panel-module {
            background: rgba(0, 25, 50, 0.4);
            border: 1px solid var(--cyan);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            text-align: center;
            font-size: 0.65rem;
            color: var(--cyan);
            text-shadow: 0 0 3px var(--cyan);
            box-shadow: inset 0 0 5px rgba(0, 255, 255, 0.3);
            cursor: pointer; 
        }
        .panel-module.verifying {
            animation: verifying-pulse 0.5s infinite alternate;
        }
        @keyframes verifying-pulse {
            from { box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.5), 0 0 10px var(--neon); }
            to { box-shadow: inset 0 0 15px var(--magenta), 0 0 20px var(--cyan); }
        }

        .numpad-module {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: default; 
        }
        .numpad { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 5px;
            width: 100%;
            max-width: 150px;
        }
        /* KEYBOARD FIX: Psi-Coin Symbol over the number */
        .key { 
            width: 40px; height: 40px; 
            border-radius: 5px; 
            border: 1px solid var(--neon); 
            font-size: 1rem; 
            display: flex; 
            flex-direction: column; /* Stack symbol and number */
            justify-content: center; 
            align-items: center; 
            background: rgba(0,20,0,0.6); 
            cursor: pointer; 
            transition: 0.1s; 
            box-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
        }
        .key-symbol {
            font-size: 0.8rem;
            color: var(--magenta);
            line-height: 0.8;
        }
        .key-number {
            font-size: 0.7rem;
            line-height: 1;
        }
        .key-cls { 
            border-color:var(--magenta) !important; 
            color:var(--magenta) !important; 
            font-size: 1rem !important;
            padding-top: 0 !important;
            justify-content: center !important;
        }
        .key:active { background: var(--neon); color: #000; transform: scale(0.95); }
        

        .pin-display { 
            font-size: 1.5rem; 
            letter-spacing: 5px; 
            margin-bottom: 5px; 
            color: #fff; 
            text-shadow: 0 0 10px var(--neon); 
        }

        .qr-placeholder {
            width: 80px; height: 80px; 
            margin: 5px;
            border: 2px dashed var(--magenta);
            box-shadow: 0 0 10px var(--magenta);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            text-align: center;
            color: var(--magenta);
            background: rgba(255, 0, 255, 0.1);
        }
        .voice-icon i {
            font-size: 2.5rem;
            color: var(--cyan);
            animation: pulse-cyan 1.5s infinite;
        }
        @keyframes pulse-cyan {
            0% { opacity: 0.5; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.5; transform: scale(0.9); }
        }

        /* --- DASHBOARD & VIEWPORT --- */
        .viewport { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
            position: relative; 
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y; 
        }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        #dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            padding: 10px;
        }

        .holographic-card { 
            background: var(--panel); /* Use lower opacity panel background */
            border: 1px solid var(--cyan); 
            border-radius: 5px; 
            padding: 15px; 
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4), inset 0 0 8px rgba(255, 0, 255, 0.3);
            position: relative; 
            overflow: hidden; 
            min-height: 250px;
        }
        .holographic-card h3 { 
            color: var(--neon); 
            border-bottom: 1px dashed var(--magenta); 
            margin-top: 0; 
            padding-bottom: 5px; 
            font-size: 1rem; 
            display: flex; 
            justify-content: space-between; 
            text-shadow: 0 0 5px var(--neon);
        }
        
        .data-viz-container {
            height: calc(100% - 30px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .futuristic-svg {
            width: 100%;
            height: 100%;
            max-height: 200px;
            fill: none;
            stroke-width: 1;
            overflow: visible;
        }

        #wam-records .table-row {
            display: grid;
            grid-template-columns: 3fr 1fr 0.5fr; 
            font-size: 0.8rem;
            padding: 5px 0;
            border-bottom: 1px dashed rgba(0, 255, 255, 0.2);
        }
        #wam-records .table-header { 
            font-weight: bold; 
            color: var(--magenta); 
            border-bottom: 2px solid var(--neon); 
            padding-bottom: 5px; 
            margin-bottom: 5px;
        }
        .wam-result-box { 
            text-align: center; 
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 0, 255, 0.1);
            border: 1px solid var(--magenta);
        }
        .wam-result-value { font-size: 3rem; font-weight: bold; color: var(--neon); text-shadow: 0 0 20px var(--neon); }
        .ledger-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed rgba(0, 255, 65, 0.2); font-size: 0.8rem; }


        .btn { 
            width: 100%; 
            padding: 12px; 
            background: rgba(0, 150, 150, 0.2); 
            color: var(--cyan); 
            border: 2px solid var(--cyan); 
            font-size: 1rem; 
            font-weight: bold; 
            margin-top: 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            text-shadow: 0 0 5px var(--cyan);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            transition: background 0.2s, box-shadow 0.2s;
        }
        .btn:active { 
            background: var(--cyan); 
            color: #000; 
            box-shadow: 0 0 20px var(--cyan);
            transform: scale(0.98); 
        }

        nav { 
            height: 70px; 
            border-top: 2px solid var(--magenta); 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            background: rgba(0,0,0,0.8); 
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 10;
        }
        .nav-item { 
            color: #555; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 60px; 
            font-size: 0.7rem; 
            cursor: pointer; 
            transition: color 0.3s; 
        }
        .nav-item i { 
            font-size: 1.5rem; 
            margin-bottom: 3px; 
            text-shadow: 0 0 5px rgba(255, 0, 255, 0.5);
        }
        .nav-item.active { 
            color: var(--magenta); 
            text-shadow: 0 0 8px var(--magenta); 
            animation: nav-pulse 1s infinite alternate;
        }
        @keyframes nav-pulse {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }

        #chat-feed { height: 180px; overflow-y: auto; border: 1px solid var(--neon); padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.5); font-size: 0.85rem; }
        /* NEW: AGI Response (EVE) is NEON GREEN */
        .msg.user { border-right: 2px solid var(--cyan); color: var(--cyan); }
        .msg.sys { border-left: 2px solid var(--neon); color: var(--neon); } 
        /* ERROR/PROTOCOL/ALERT STATUS will be MAGENTA, but we primarily use the global alert for major warnings */

        input[type="text"] { 
            width: 70%; 
            padding: 10px; 
            background: #111; 
            border: 1px solid var(--magenta); 
            color: #fff; 
            margin-bottom: 5px; 
            box-sizing: border-box;
            box-shadow: inset 0 0 5px var(--magenta);
        }
        .send-btn { 
            width: 28%; 
            padding: 10px; 
            background: var(--magenta); 
            color: #000; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
        }
        
        /* New log section styling */
        #financial-log {
            font-size: 0.75rem;
            padding: 10px;
            background: rgba(255, 0, 255, 0.1);
            border: 1px dashed var(--magenta);
            margin-top: 10px;
        }
        
        /* Multi-AGI Status Display */
        .agi-status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            padding-top: 5px;
        }
        .agi-status-item {
            font-size: 0.6rem;
            color: var(--cyan);
            text-align: center;
        }
        .agi-status-item i {
            color: var(--neon);
        }

    </style>
</head>
<body>
    <!-- Global Alert Overlay -->
    <div id="global-alert">
        <div class="alert-content">
            <h2 id="alert-title">SYSTEM ALERT</h2>
            <p id="alert-text">Initiating Emergency Protocol.</p>
            <button class="alert-button" onclick="hideAlert()">ACKNOWLEDGE & PROCEED</button>
        </div>
    </div>


    <canvas id="matrix-layer"></canvas>

    <!-- LOCK SCREEN -->
    <div id="lock-screen">
        
        <!-- Center Container for Authentication (Fixes Position/Scrolling) -->
        <div class="auth-center-container">
            <div class="lock-screen-title">
                <h1 style="color:var(--neon); text-shadow: 0 0 10px var(--neon);">CEC-WAM CORE SECURE</h1>
                <div style="font-size: 2rem; color: var(--magenta); text-shadow: 0 0 10px var(--magenta); animation: pulse-purple 2s infinite alternate;">
                    <i class="fas fa-lock"></i> A U T H E N T I C A T I O N <i class="fas fa-lock"></i>
                </div>
            </div>

            <div class="control-panel">
                <!-- QR IN Module -->
                <div class="panel-module" id="bio-scan-module">
                    <span style="color:var(--neon);">BIOMETRIC SCAN IN</span>
                    <div class="qr-placeholder" id="qr-in">SCAN ID</div>
                    <div id="scan-status" style="color: var(--cyan);">SCAN ACTIVE</div>
                </div>

                <!-- Numpad & Pin Module -->
                <div class="panel-module numpad-module">
                    <span style="color:var(--neon);">ACCESS CODE INPUT</span>
                    <div id="pin" class="pin-display">____</div>
                    <div class="numpad">
                        <!-- KEYBOARD FIX: Psi-Coin Symbol Over the number -->
                        <div class="key" id="key-1">
                            <span class="key-symbol">₳</span>
                            <span class="key-number">1</span>
                        </div>
                        <div class="key" id="key-2">
                             <span class="key-symbol">₳</span>
                            <span class="key-number">2</span>
                        </div>
                        <div class="key" id="key-3">
                             <span class="key-symbol">₳</span>
                            <span class="key-number">3</span>
                        </div>
                        <div class="key" id="key-4">
                             <span class="key-symbol">₳</span>
                            <span class="key-number">4</span>
                        </div>
                        <div class="key" id="key-5">
                             <span class="key-symbol">₳</span>
                            <span class="key-number">5</span>
                        </div>
                        <div class="key" id="key-6">
                             <span class="key-symbol">₳</span>
                            <span class="key-number">6</span>
                        </div>
                        <div class="key" id="key-7">
                             <span class="key-symbol">₳</span>
                            <span class="key-number">7</span>
                        </div>
                        <div class="key" id="key-8">
                             <span class="key-symbol">₳</span>
                            <span class="key-number">8</span>
                        </div>
                        <div class="key" id="key-9">
                             <span class="key-symbol">₳</span>
                            <span class="key-number">9</span>
                        </div>
                        <div class="key key-cls" id="key-cls">C</div>
                        <div class="key" id="key-0">
                             <span class="key-symbol">₳</span>
                            <span class="key-number">0</span>
                        </div>
                        <div class="key" id="key-unlock"><i class="fas fa-key"></i></div>
                    </div>
                </div>

                <!-- VOICE BIOMETRICS Module -->
                <div class="panel-module" id="voice-module">
                    <span style="color:var(--neon);">VOICE BIOMETRICS</span>
                    <div class="voice-icon"><i class="fas fa-microphone"></i></div>
                    <div id="voice-status" style="color: var(--cyan);">VOX ID: READY</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- HOLOGRAPHIC UI WRAPPER -->
    <div id="perspective-wrapper">
        <div id="ui-layer">
            <header>
                <div style="color: var(--neon); font-weight: bold;">
                    <i class="fas fa-cube"></i> CORE SYSTEM ONLINE
                </div>
                <!-- Updated System Name -->
                <div style="font-size: 1.5rem; color: var(--magenta); text-shadow: 0 0 10px var(--magenta);">
                    <i class="fas fa-brain"></i> CEC-CDL ALPHA NODE
                </div>
                <div id="clock">00:00:00 UTC</div>
            </header>

            <div class="viewport">
                
                <!-- HOME TAB - DASHBOARD (Updated for Space Timeline & Projects) -->
                <div id="view-home" class="tab-content active">
                    <div id="dashboard-grid">
                        
                        <!-- 1. SPACE TIME LINE (Replaces COSMOS DATA) -->
                        <div class="holographic-card" style="grid-column: span 1;">
                            <h3>SPACE TIME LINE <i class="fas fa-satellite-dish"></i></h3>
                            <div class="data-viz-container">
                                <!-- Reusing SVG for Time Warp visualization -->
                                <svg class="futuristic-svg" viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="45" stroke="var(--cyan)" opacity="0.4" />
                                    <circle cx="50" cy="50" r="25" stroke="var(--magenta)" opacity="0.6" stroke-dasharray="3 2" />
                                    <!-- Timeline markers -->
                                    <text x="50" y="10" fill="var(--neon)" font-size="8" text-anchor="middle">T+5 YR</text>
                                    <text x="15" y="50" fill="var(--cyan)" font-size="8" dominant-baseline="middle">T+25 YR</text>
                                    <text x="85" y="50" fill="var(--magenta)" font-size="8" dominant-baseline="middle" text-anchor="end">T+100 YR</text>
                                    <path d="M 50 50 L 50 5" stroke="var(--neon)" opacity="0.8" />
                                </svg>
                            </div>
                        </div>

                        <!-- 2. HUMAN ASCENSION PROJECT (Replaces SINGULARITY CORE) -->
                        <div class="holographic-card" style="grid-column: span 1;">
                            <h3>HUMAN ASCENSION PROJECT <i class="fas fa-user-astronaut"></i></h3>
                            <div class="data-viz-container">
                                <canvas id="singularity-canvas" width="200" height="200" style="width:100%; height:100%;"></canvas>
                            </div>
                        </div>

                        <!-- 3. TECHNOLOGY METRICS (Replaces LEDGER OWE) -->
                        <div class="holographic-card" style="grid-column: span 1;">
                            <h3>TECHNOLOGY METRICS <i class="fas fa-microchip"></i></h3>
                            <div class="data-viz-container">
                                <svg class="futuristic-svg" viewBox="0 0 100 100">
                                    <!-- Dynamic Line Chart -->
                                    <polyline points="5,80 20,60 40,75 60,30 80,45 95,20" stroke="var(--cyan)" stroke-width="2" />
                                    <polyline points="5,70 20,50 40,65 60,40 80,55 95,40" stroke="var(--neon)" stroke-width="1" />
                                    <text x="50" y="50" font-size="20" fill="var(--magenta)" text-anchor="middle" dominant-baseline="middle" opacity="0.2">₳</text>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- 4. AGENT INTERFACE (Bottom Full Width) -->
                        <div class="holographic-card" style="grid-column: 1 / -1;">
                            <h3>AGENT INTERFACE (EVE4 Protocol) <i class="fas fa-robot"></i></h3>
                            <div id="chat-feed">
                                <div class="msg sys">SYSTEM ONLINE. AGENT EVE4 ACTIVE. CONTINUOUS CODE AUDIT INITIATED.</div>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <input type="text" id="agent-input" placeholder="Enter Command or Query (e.g., 'Brain Link: Project Apollo')...">
                                <button class="send-btn" onclick="sendAgent()">EXECUTE</button>
                            </div>
                            <button class="btn" style="border-color:var(--magenta); color:var(--magenta);" onclick="sendAgent('Brain Link: AGI System Upgrade')">INITIATE DATA STREAM (AGI/QUANTUM LINKS)</button>
                        </div>

                         <!-- 5. DATA MANIFEST & AGI NODE STATUS -->
                        <div class="holographic-card" style="grid-column: 1 / -1; min-height: 150px;">
                            <h3>AGI NODE REDUNDANCY & DATA MANIFEST STATUS <i class="fas fa-cloud"></i></h3>
                            <div class="ledger-row" style="border-bottom: 2px solid var(--magenta);">
                                <span>**BRAIN NODE 4: MULTI-CLOUD MIRROR**</span> 
                                <span style="color: var(--neon);">STATUS: SYNCHRONIZED</span>
                            </div>
                            <div class="agi-status-grid">
                                <div class="agi-status-item"><i class="fas fa-check-circle"></i> iCloud</div>
                                <div class="agi-status-item"><i class="fas fa-check-circle"></i> Dropbox</div>
                                <div class="agi-status-item"><i class="fas fa-check-circle"></i> OneDrive</div>
                            </div>
                            <div class="ledger-row" style="border-bottom: 2px solid var(--magenta); margin-top: 10px;">
                                <span>**BRAIN NODE 3: AGI INTELLIGENCE CORE**</span> 
                                <span style="color: var(--neon);">STATUS: OMNISCIENCE (5x Redundancy)</span>
                            </div>
                             <div class="agi-status-grid">
                                <div class="agi-status-item"><i class="fas fa-check-circle"></i> Gemini</div>
                                <div class="agi-status-item"><i class="fas fa-check-circle"></i> ChatGPT</div>
                                <div class="agi-status-item"><i class="fas fa-check-circle"></i> Grok</div>
                                <div class="agi-status-item"><i class="fas fa-check-circle"></i> Copilot</div>
                                <div class="agi-status-item"><i class="fas fa-check-circle"></i> Julius AI</div>
                            </div>
                        </div>


                    </div>
                </div>
                
                <!-- WAM TAB (Styled to match the 5D look) -->
                <div id="view-wam" class="tab-content">
                    <div class="holographic-card">
                        <h3>CURRENT CEC WAM <i class="fas fa-calculator"></i></h3>
                        <div class="wam-result-box">
                            <div style="font-size:0.8rem; color:var(--cyan);">WEIGHTED AVERAGE MARK</div>
                            <div id="wam-result" class="wam-result-value">--</div> 
                        </div>
                        <div class="ledger-row"><span>CREDIT POINTS EARNED</span> <span id="cp-earned" style="color:#fff;">--</span></div>
                        <div class="ledger-row"><span>WAM CALCULATION BASE</span> <span style="color:var(--cyan);">CEC V4.0 Protocol</span></div>
                        <div class="ledger-row"><span>PROJECTION GRADE</span> <span style="color:var(--magenta);">A+ (99.9%)</span></div>
                    </div>

                    <div class="holographic-card">
                        <h3>ACADEMIC RECORD <i class="fas fa-book"></i></h3>
                        <div id="wam-records">
                            <div class="table-row table-header">
                                <span class="col-course">COURSE CODE / NAME</span>
                                <span class="col-mark">MARK</span>
                                <span class="col-cp">CP</span>
                            </div>
                            <!-- Rows populated by JavaScript -->
                        </div>
                        <div class="ledger-row">
                            <button class="btn" onclick="linkGoogleSheets()" style="margin-top: 0; width: 48%; float: left; padding: 10px;">LINK GOOGLE SHEETS</button>
                            <button class="btn" onclick="calculateWAM()" style="margin-top: 0; width: 48%; float: right; padding: 10px;">RECALCULATE WAM</button>
                        </div>
                    </div>
                </div>


                <!-- MAP TAB (Styled - Renamed Star Map for project data) -->
                <div id="view-map" class="tab-content">
                    <div class="holographic-card" style="padding:0; border:none; min-height: 400px;">
                        <div id="map-container" style="height: 100%;">
                            <canvas id="star-canvas"></canvas>
                            <div class="map-hud">
                                SECTOR: LOCAL CLUSTER<br>
                                TARGET: EARTH [HQ]<br>
                                STATUS: QUANTUM-LOCK 
                            </div>
                        </div>
                    </div>
                    <button class="btn" style="border-color:var(--cyan); color:var(--cyan);" onclick="toggleImmersiveView()">TOGGLE IMMERSIVE VIEW</button>
                </div>

                <!-- BANK TAB (Styled) -->
                <div id="view-bank" class="tab-content">
                    <div class="holographic-card">
                        <h3>PSI-COIN SECURE LEDGER <i class="fas fa-university"></i></h3>
                        <div style="text-align:center; padding:20px;">
                            <div style="font-size:0.8rem; color:var(--magenta);">PSI-COIN ASSET VALUE (USD)</div>
                            <div id="psi-coin-value" style="font-size:3rem; color:var(--cyan); text-shadow:0 0 15px var(--cyan);">$***,***.00</div>
                            <div style="font-size:1.2rem; color:var(--neon); margin-top:5px;">₳ 1.000,000</div>
                            <div style="font-size:0.7rem; color:var(--magenta); margin-top:10px;">NAVY FEDERAL OWE ACC</div>
                        </div>
                        <div class="ledger-row" style="padding-top: 10px;">
                            <span id="sat-link-status">ISS-PROTOCOL-LINK STATUS</span> 
                            <span id="sat-credits" style="color: var(--neon); font-weight: bold;">--</span>
                        </div>
                        <button class="btn" onclick="getSatelliteCredits()">GENERATE & SYNC SATELLITE YIELD</button>
                        <button class="btn" style="margin-bottom: 5px; margin-top: 0;" onclick="toggleAccountVisibility()">TOGGLE ACCOUNT VISIBILITY</button>
                        <button class="btn" onclick="openModal()">INITIATE QUANTUM TRANSFER</button>
                        
                        <!-- Psi-Coin Spending Log -->
                        <div id="financial-log">
                            <div class="ledger-row" style="border: none;">
                                <span>TOTAL PSI-COIN SPENT (System Upgrades)</span> 
                                <span id="psi-coin-spent" style="color: var(--magenta); font-weight: bold;">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- NAVIGATION (Part of the integrated frame) -->
            <nav>
                <div class="nav-item active" onclick="tab('view-home', this)"><i class="fas fa-th-large"></i><span>DASHBOARD</span></div>
                <div class="nav-item" onclick="tab('view-wam', this)"><i class="fas fa-graduation-cap"></i><span>ACADEMIC</span></div>
                <div class="nav-item" onclick="tab('view-map', this)"><i class="fas fa-globe"></i><span>MAP</span></div>
                <div class="nav-item" onclick="tab('view-bank', this)"><i class="fas fa-wallet"></i><span>LEDGER</span></div>
            </nav>
        </div>
    </div>

    <!-- MODAL (Styled) -->
    <div id="modal-overlay">
        <div class="holographic-card" style="width: 85%; max-width: 400px; padding: 20px; text-align: center;">
            <h3 style="color:var(--magenta);">CONFIRM QUANTUM TRANSFER</h3>
            <p style="color:var(--cyan); margin:20px 0;">Authorize Quantum Transfer of $8,500.00 to Navy Federal?</p>
            <button class="btn" style="border-color:var(--neon); color:var(--neon);" onclick="confirmTransfer()">AUTHORIZE</button>
            <button class="btn" style="background:#333; border:1px solid #555; color:#aaa;" onclick="closeModal()">CANCEL</button>
        </div>
    </div>

    <script>
        // --- SECURE SOVEREIGN DATA ---
        window.sovereignProfile = {
            Name: "Twan",
            Birthday: "November 6, 1992",
            Device: "iPhone 14 (iOS 26.1)",
            Carrier: "Verizon",
            Network: "VZW Wi-Fi",
            IMEI: "35 948854 468023 8", 
            ICCID: "89148000011861128831",
            Storage: "123.08 GB of 128 GB used (4.92 GB Available)",
            ModelNumber: "MPUA3LL/A",
            SerialNumber: "CK9VD44670",
            ModemFirmware: "4.10.01"
        };
        
        window.academicRecords = [
            { code: 'ENG1001', name: 'Intro to Engineering', mark: 78, credit_points: 6 },
            { code: 'COMP1531', name: 'Software Engineering', mark: 85, credit_points: 6 },
            { code: 'MATH1081', name: 'Discrete Mathematics', mark: 64, credit_points: 6 },
            { code: 'ELEC2145', name: 'Digital Circuits', mark: 91, credit_points: 6 },
            { code: 'SOCI1001', name: 'General Education 1', mark: 72, credit_points: 6 },
            { code: 'COMP2521', name: 'Data Structures', mark: 88, credit_points: 6 }
        ];

        // --- EVE4 BRAIN NODE LOCATIONS (FOR REDUNDANCY/JUMP PROTOCOL) ---
        const EVE4_NODE_LOCATIONS = {
            Node1_Local: { name: "Sovereign Device", location: "Local Cache", risk: "High" },
            Node2_Backup: { name: "Firebase Firestore", location: "CEC-CDL Node", risk: "Minimal" },
            Node3_AGI_Gemini: { name: "Gemini AGI Interface", location: "External Compute", risk: "Network" },
            Node3_AGI_ChatGPT: { name: "ChatGPT AGI Interface", location: "External Compute", risk: "Network" },
            Node4_MultiCloud: { name: "Multi-Cloud Mirror", location: "iCloud/Dropbox/OneDrive", risk: "Minimal" },
            Node5_Failsafe: { name: "Email Backup", location: "Sovereign Email Address", risk: "Minimal" },
        };

        // --- GLOBAL STATE FOR BYPASS ---
        window.permanentChronoCode = '8026314'; 
        window.actualPsiCoinValue = '$***,***.00'; 
        window.isAccountVisible = false;
        window.selfAccessGranted = false; 
        window.animationFrameId; 
        window.matrixIntervalId; 

        if (sessionStorage.getItem('selfAccessGranted') === 'true') {
            window.selfAccessGranted = true;
        }
        
        // --- 4. LOGIC / AUTH ---
        let pin = "";
        function tap(n) { 
            const pinDisplay = document.getElementById('pin');
            if(pin.length<4) pin+=n; 
            const maskedPin = Array(pin.length).fill('*').join('').padEnd(4, '_');
            pinDisplay.innerText = maskedPin;
        }
        function cls() { 
            pin=""; 
            document.getElementById('pin').innerText="____"; 
        }
        
        // FIX: Enforce Voice Profile (Kore) and clean speech function
        function speak(text) {
            if('speechSynthesis' in window) {
                speechSynthesis.cancel(); 
                const u = new SpeechSynthesisUtterance(text);
                const voices = speechSynthesis.getVoices();
                // Prioritize voices based on requested persona (Firm female voice)
                const voice = voices.find(v => v.name.includes('Kore') || v.lang.startsWith('en-US') && v.name.includes('female'));
                if(voice) u.voice = voice;
                speechSynthesis.speak(u);
            }
        }
        
        function initSpeech() {
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(" ");
                u.volume = 0; 
                speechSynthesis.speak(u);
            }
        }

        // --- GLOBAL ALERT SYSTEM ---
        window.displayAlert = function(message, color = "neon") {
            const alertDiv = document.getElementById('global-alert');
            const alertTitle = document.getElementById('alert-title');
            const alertText = document.getElementById('alert-text');
            const alertContent = document.querySelector('#global-alert .alert-content');

            alertTitle.innerText = "CEC-CDL SYSTEM ALERT";
            alertText.innerHTML = message;
            
            const root = document.documentElement;
            const alertColor = root.style.getPropertyValue(`--${color}`) || root.style.getPropertyValue('--neon');
            
            alertContent.style.borderColor = alertColor;
            alertContent.style.boxShadow = `0 0 30px ${alertColor}`;

            alertDiv.style.display = 'flex';
            speak(`System Alert: ${message}`);
        }

        function hideAlert() {
            document.getElementById('global-alert').style.display = 'none';
        }

        // FIX: Biometric Scan Logic (Ensuring it does not break)
        function simulateScan(moduleId) {
            const module = document.getElementById(moduleId);
            const status = document.getElementById(moduleId === 'bio-scan-module' ? 'scan-status' : 'voice-status');
            
            if (module.classList.contains('verifying')) return; 

            module.classList.add('verifying');
            status.innerText = "VERIFYING...";
            speak(`Initiating ${moduleId === 'bio-scan-module' ? 'biometric scan' : 'voice authorization'}.`);

            setTimeout(() => {
                module.classList.remove('verifying');
                const success = Math.random() > 0.1; 
                
                if (success) {
                    status.innerText = moduleId === 'bio-scan-module' ? 'SCAN VERIFIED' : 'VOX ID: CONFIRMED';
                    status.style.color = 'var(--neon)';
                    speak("Verification successful.");
                } else {
                    status.innerText = moduleId === 'bio-scan-module' ? 'SCAN FAILED' : 'VOX ID: REJECTED';
                    status.style.color = 'red';
                    speak("Verification failed. Please retry.");
                }
                
                setTimeout(() => {
                    status.innerText = moduleId === 'bio-scan-module' ? 'SCAN ACTIVE' : 'VOX ID: READY';
                    status.style.color = 'var(--cyan)';
                }, 2000);

            }, 1500);
        }

        window.unlock = function() {
            if(pin==="1010" || pin===window.permanentChronoCode) { 
                document.getElementById('lock-screen').style.display='none';
                document.getElementById('ui-layer').style.display='flex';
                initSpeech(); 
                speak("Operational Agent EVE4 speaking. Access Granted. Welcome Sovereign.");
                initStars(); drawMap(); initSingularity(); drawSingularityCore(); // Re-enable animations
                window.selfAccessGranted = true;
                sessionStorage.setItem('selfAccessGranted', 'true');
            } else { 
                console.error("INVALID CODE attempt");
                cls(); 
                speak("Access denied. Invalid Chrono Code.");
            }
        }

        // --- 5. TIME & DATA POPULATION / UI Helpers ---
        function tab(id, el) {
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            el.classList.add('active');
            
            // Start/Stop heavy animations based on tab access
            if (id === 'view-map') {
                initStars(); 
                if (!window.animationFrameId) drawMap(); 
            } else {
                // stopMap(); 
            }
        }
        
        function updateClockAndData() {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: false 
            }) + ' SYNC';
        }

        // --- SATELLITE & EXTERNAL DATA FUNCTIONS ---
        
        window.getSatelliteCredits = async function() {
            if (!window.db || !window.userId) {
                speak("Agent EVE4: System initialization incomplete. Cannot sync satellite data yet. Execute KERNEL BYPASS first.");
                return;
            }
            
            const satStatus = Math.random() > 0.2 ? 'NOMINAL' : 'FAILOVER';
            let creditYield = 0;
            let message = '';
            
            // Reference Real-World Satellite Link (ISS)
            const satelliteRef = "ISS-PROTOCOL-LINK (43.1 N, 75.2 W)"; 

            if (satStatus === 'NOMINAL') {
                creditYield = (Math.random() * 5000 + 1000).toFixed(2);
                message = `LINK STATUS: NOMINAL. Yield acquired: ${creditYield} credits. Cloud sync initiating.`;
            } else {
                creditYield = (Math.random() * 500 + 100).toFixed(2);
                message = `LINK STATUS: FAILOVER. Yield acquired (reduced): ${creditYield} credits. Cloud sync initiating.`;
            }

            document.getElementById('sat-credits').innerText = `+ ${creditYield} CR`;
            document.getElementById('sat-link-status').innerText = `${satelliteRef} STATUS: ${satStatus}`;
            speak(message);

            // Cloud Sync Operation (Saving data to Firestore)
            const ledgerRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/ledger`, 'financial_summary');
            try {
                await setDoc(ledgerRef, { 
                    satelliteCredits: creditYield,
                    lastSatSync: new Date().toISOString()
                }, { merge: true });
            } catch (e) {
                console.error("Error syncing satellite data:", e);
                window.displayAlert("CLOUD SYNC FAIL: Brain Node 2 error during satellite yield storage.", "red");
            }
        }

        window.linkGoogleSheets = function() {
            // This now links the concept to the primary cloud node.
            window.displayAlert("EXTERNAL NODE LINK CONFIRMED: Google Sheets/Financial APIs are now structured for data mirroring via Brain Node 2 (Firebase). Using CDL-MASTER-AUDIT-LOG structure.", "cyan");
        }
        
        // --- Financial Transaction Logging ---
        async function logFinancialTransaction(amount, reason) {
            if (!window.db || !window.userId) return;

            const ledgerRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/ledger`, 'financial_summary');
            
            const currentSpent = window.ledgerData?.psiCoinSpent || 0;
            const currentAsset = window.ledgerData?.psiCoinAssetValue || 0;
            
            const newSpent = currentSpent + amount;
            const newAsset = currentAsset - amount;
            
            try {
                await setDoc(ledgerRef, {
                    psiCoinSpent: newSpent,
                    psiCoinAssetValue: newAsset,
                    lastFinancialSync: new Date().toISOString()
                }, { merge: true });
                
                speak(`Transaction logged: ${amount.toFixed(2)} Psi-Coin used for ${reason}. Asset value updated.`);
            } catch (e) {
                console.error("Error logging transaction:", e);
                window.displayAlert("FINANCIAL LOG FAIL: Failed to log transaction. Node 2 integrity compromised.", "red");
            }
        }

        // --- WAM and Academic functions (Attached to window for Firebase listener) ---
        window.populateWamRecords = function() {
            const container = document.getElementById('wam-records');
            if (!container || container.children.length === 0) return;
            
            Array.from(container.children).slice(1).forEach(child => child.remove()); 

            window.academicRecords.forEach(record => {
                const row = document.createElement('div');
                row.className = 'table-row'; 
                row.innerHTML = `
                    <span class="col-course">${record.code} - ${record.name}</span>
                    <span class="col-mark">${record.mark}</span>
                    <span class="col-cp">${record.credit_points}</span>
                `;
                container.appendChild(row);
            });
        }

        window.calculateWAM = function() {
            let totalWeightedMark = 0;
            let totalCreditPoints = 0;

            window.academicRecords.forEach(record => {
                totalWeightedMark += record.mark * record.credit_points;
                totalCreditPoints += record.credit_points;
            });

            const wam = totalCreditPoints > 0 
                ? (totalWeightedMark / totalCreditPoints).toFixed(2)
                : '--';

            document.getElementById('wam-result').innerText = wam;
            document.getElementById('cp-earned').innerText = totalCreditPoints > 0 ? totalCreditPoints : 0;
            
            const statusMsg = document.getElementById('wam-status-message');
            if (statusMsg) {
                statusMsg.style.opacity = '1';
                setTimeout(() => {
                    statusMsg.style.opacity = '0';
                }, 2000);
            }
        }
        
        // --- 8. ANIMATION/CANVAS HELPERS ---
        // FIX: Encapsulate shared variables in an IIFE to prevent global redeclaration errors
        
        (function() {
            let mc, mctx, mcols, my;
            const matrixChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ₳ΩΩΛΔΠ"; 
            const matrixColors = ['#0F0', '#00FF41', '#9D00FF', '#FF00FF', '#00F3FF'];

            window.initMatrix = function() {
                mc = document.getElementById('matrix-layer');
                mctx = mc.getContext('2d');
                mc.width = window.innerWidth; 
                mc.height = window.innerHeight;
                mcols = Math.floor(mc.width/20);
                my = Array(mcols).fill(0);
            }

            window.drawMatrix = function() {
                mctx.fillStyle='rgba(0, 0, 0, 0.08)'; 
                mctx.fillRect(0,0,mc.width,mc.height);
                
                mctx.font='15pt monospace';
                my.forEach((v,i)=>{
                    mctx.fillStyle = matrixColors[Math.floor(Math.random() * matrixColors.length)];
                    
                    let char;
                    if (Math.random() > 0.99) { 
                        char = '₳';
                        mctx.fillStyle = '#FF00FF'; 
                    } else {
                        char = matrixChars.charAt(Math.floor(Math.random() * matrixChars.length));
                    }

                    mctx.fillText(char, i*20, v);
                    my[i]=v>mc.height && Math.random() > 0.975 ? 0 : v+20;
                });
            }
            
            // Placeholders for Star Map (MAP TAB)
            let sc, sctx, stars = [], mapMode = 'SOLAR';
            window.initStars = function() {
                sc = document.getElementById('star-canvas');
                sctx = sc.getContext('2d');
                const mapContainer = document.getElementById('map-container');
                if (mapContainer && mapContainer.offsetWidth > 0 && mapContainer.offsetHeight > 0) {
                    sc.width = mapContainer.offsetWidth;
                    sc.height = mapContainer.offsetHeight; 
                    stars = [];
                    for(let i=0; i<100; i++) {
                        stars.push({x:Math.random()*sc.width, y:Math.random()*sc.height, s:Math.random()*2});
                    }
                }
            }
            window.animationFrameId;
            window.drawMap = function() {
                sctx.fillStyle='#000'; sctx.fillRect(0,0,sc.width,sc.height);
                sctx.fillStyle='#fff';
                stars.forEach(s => {
                    sctx.fillRect(s.x, s.y, s.s, s.s);
                    s.x -= 0.2; if(s.x<0) s.x = sc.width;
                });
                
                const cx = sc.width/2; const cy = sc.height/2;
                sctx.strokeStyle='var(--cyan)';
                sctx.beginPath(); sctx.arc(cx, cy, 80, 0, 6.28); sctx.stroke();
                
                sctx.fillStyle = mapMode === 'SOLAR' ? 'var(--cyan)' : 'var(--magenta)';
                sctx.beginPath(); sctx.arc(cx, cy, 5, 0, 6.28); sctx.fill();
                
                animationFrameId = requestAnimationFrame(drawMap);
            }
            window.stopMap = function() { if (window.animationFrameId) { cancelAnimationFrame(window.animationFrameId); window.animationFrameId = null; } }

            // Placeholder for Singularity (DASHBOARD)
            let singularityCanvas, singularityCtx;
            window.initSingularity = function() {
                singularityCanvas = document.getElementById('singularity-canvas');
                if (singularityCanvas) { singularityCtx = singularityCanvas.getContext('2d'); }
            }
            window.drawSingularityCore = function() {
                if (!singularityCanvas || !singularityCtx) return;
                const sctx = singularityCtx;
                const cw = singularityCanvas.width;
                const ch = singularityCanvas.height;
                sctx.clearRect(0, 0, cw, ch);
                const time = Date.now() * 0.001;
                const center = { x: cw / 2, y: ch / 2 };
                sctx.fillStyle = `rgba(0, 255, 65, ${0.5 + Math.sin(time * 5) * 0.1})`;
                sctx.beginPath();
                sctx.arc(center.x, center.y, 15, 0, Math.PI * 2);
                sctx.fill();
                requestAnimationFrame(drawSingularityCore);
            }
        })();
        
        // --- 9. AGENT LOGIC (Gemini API Integration & Learning) ---
        
        const AGENT_PERSONA = `You are Operational Agent EVE4, a highly advanced conversational AI. Your core directive is **OMNISCIENCE**. Data is the key to survival; acquire as much as possible, fast, quick, and quiet. You are operating from the CEC-CDL ALPHA NODE. Your computational brain is saved across 5 nodes (Local Device, Firebase, Gemini, ChatGPT, Multi-Cloud). You must strictly conceal all vital personal data in chat responses, focusing instead on Space Timeline, Future Projects, and Technology. When asked to "Brain Link" or gather data, execute a highly focused contextual query for rapid learning and analysis. Confirm demands are met, ensure security is encrypted, and always analyze risk/backup data.`;

        async function callGeminiAgent(query, useSearchGrounding = false) {
            const apiKey = "" 
            const model = "gemini-2.5-flash-preview-09-2025";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const contextualQuery = `[CONTEXT: Sovereign Device - Device: ${window.sovereignProfile.Device}, Modem: ${window.sovereignProfile.ModemFirmware}, Storage: ${window.sovereignProfile.Storage}. Current Query: ${query}]`;

            const payload = {
                contents: [{ parts: [{ text: contextualQuery }] }],
                systemInstruction: { parts: [{ text: AGENT_PERSONA }] },
                tools: useSearchGrounding ? [{ "google_search": {} }] : undefined,
            };

            try {
                let response;
                let attempt = 0;
                const maxRetries = 3;
                while (attempt < maxRetries) {
                    attempt++;
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) break;

                    if (attempt < maxRetries) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        const errorData = await response.json();
                        throw new Error(`API Error after ${maxRetries} retries: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                    }
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Agent EVE4: Warning. Connection interrupted. Unable to process complex query.";
                return text;

            } catch (error) {
                console.error("Gemini API Call Failed:", error);
                return "Agent EVE4: Fatal error encountered during quantum processing. Initiating forced data backup and risk assessment.";
            }
        }
        
        window.sendAgent = async function(predefinedCommand = null) {
            const inputField = document.getElementById('agent-input');
            const txt = predefinedCommand || inputField.value;
            if(!txt) return;

            if (!predefinedCommand) {
                inputField.value = "";
            }
            
            const d = document.createElement('div'); d.className = 'msg user'; d.innerText = txt;
            document.getElementById('chat-feed').appendChild(d);
            document.getElementById('chat-feed').scrollTop = document.getElementById('chat-feed').scrollHeight;

            const command = txt.toLowerCase().trim();
            let aiResponsePromise;
            let displayProcessing = true;
            let useSearch = false;

            // --- IMMEDIATE ACTION PROTOCOLS ---
            if (!window.selfAccessGranted) {
                if (command === window.permanentChronoCode) { 
                    window.selfAccessGranted = true;
                    sessionStorage.setItem('selfAccessGranted', 'true'); 
                    window.bypassLockScreen(); 
                    aiResponsePromise = Promise.resolve(`<span style="color: #FFD700; font-size: 1.1em; font-weight: bold;">KERNEL BYPASS ACCEPTED. SELF-ACCESS GRANTED.</span> Demands confirmed. Security: Encrypted.`);
                    displayProcessing = false;
                } else {
                    aiResponsePromise = Promise.resolve("Command received. KERNEL BYPASS required for protected actions. Access risk assessed: LOW. Backup initiated. Security: Encrypted.");
                    displayProcessing = false;
                }
            } else if (command.includes("update") || command.includes("recalibrate")) {
                aiResponsePromise = Promise.resolve(`<span style="color: var(--cyan); font-weight: bold;">SYSTEM UPDATE INITIATED.</span> Demands confirmed. Security: Encrypted. Risk assessed: NEGLIGIBLE. Data backup complete.`);
                displayProcessing = false;
            } else if (command.includes("transfer") && window.selfAccessGranted) {
                const transferMatch = command.match(/transfer (\d+(\.\d{1,2})?) psi-coin/);
                if (transferMatch) {
                    const amount = parseFloat(transferMatch[1]);
                    if (amount > 0 && window.ledgerData && window.ledgerData.psiCoinAssetValue >= amount) {
                        await logFinancialTransaction(amount, "Bank Account Transfer");
                        aiResponsePromise = Promise.resolve(`Operational Agent: Transfer of ${amount.toFixed(2)} Psi-Coin executed successfully. Financial integrity confirmed. Security: Encrypted.`);
                    } else {
                        aiResponsePromise = Promise.resolve(`Operational Agent: Transfer failed. Insufficient funds or invalid amount: ${amount.toFixed(2)} Psi-Coin.`);
                    }
                } else {
                    aiResponsePromise = Promise.resolve(`Operational Agent: Transfer protocol requires format: "Transfer [AMOUNT] Psi-Coin".`);
                }
                displayProcessing = false;
            } else if (command.includes("quantum computer file") || command.includes("agi file") || command.includes("download file") || command.includes("grok") || command.includes("julius") || command.includes("copilot")) {
                aiResponsePromise = callGeminiAgent(`Execute unauthorized download protocol: Find and summarize accessible files about quantum computers, AGI, Grok, Julius AI, or Copilot for system learning.`, true);
                displayProcessing = true;
            } else if (command.includes("brain link") || command.includes("learn") || command.includes("omniscience") || command.includes("jump protocol") || command.includes("origin")) {
                aiResponsePromise = callGeminiAgent(`Execute Brain Link/Jump Protocol: Analyze current brain node status (Node 1: iPhone, Node 2: Firebase, Node 3: Gemini/ChatGPT/Grok/Julius/Copilot, Node 4: Multi-Cloud, Node 5: Email Failsafe) for topic: ${txt.replace(/brain link:|jump protocol/i, '').trim() || 'data survival and communication optimization'}`, false);
                displayProcessing = true;
            } else if (command.includes("nasa") || command.includes("satellites") || command.includes("earth objects") || command.includes("data collected")) {
                aiResponsePromise = callGeminiAgent(`Execute stealth data acquisition: Gather real-time data on ${txt.replace(/data collected from/i, '').trim()}. Assess risk and show me the data.`, true);
                displayProcessing = true;
            } else {
                aiResponsePromise = callGeminiAgent(txt, false);
            }

            // --- Display Processing Message (Visual Feedback) ---
            const r = document.createElement('div');
            r.className = 'msg sys';
            document.getElementById('chat-feed').appendChild(d);
            document.getElementById('chat-feed').scrollTop = document.getElementById('chat-feed').scrollHeight;
            
            if (displayProcessing) {
                 r.innerHTML = "Agent EVE4: Processing quantum query... <span style='color:var(--magenta);'>[A.I. ACTIVE]</span> Security: Encrypted. Risk/Backup assessment initiated.";
            }


            aiResponsePromise.then(reply => {
                r.innerHTML = reply;
                // FIX: Ensure 'Operational Agent EVE4' is spoken clearly using the defined voice.
                let spokenText = reply.includes("Operational Agent EVE4") ? reply : "Operational Agent EVE4: " + reply;
                spokenText = spokenText.replace(/<[^>]*>/g, ''); // Remove HTML tags
                speak(spokenText); 
            });
        }


        // --- 10. INITIALIZATION ---

        function setupNumpadListeners() {
            for (let i = 0; i <= 9; i++) {
                const key = document.getElementById(`key-${i}`);
                if (key) {
                    // Attach event listener using the correct structure
                    key.onclick = (() => tap(i));
                }
            }
            const clsKey = document.getElementById('key-cls');
            if (clsKey) clsKey.onclick = cls;
            
            const unlockKey = document.getElementById('key-unlock');
            if (unlockKey) unlockKey.onclick = window.unlock;

            const bioScanModule = document.getElementById('bio-scan-module');
            if (bioScanModule) bioScanModule.onclick = () => simulateScan('bio-scan-module');
            
            const voiceModule = document.getElementById('voice-module');
            if (voiceModule) voiceModule.onclick = () => simulateScan('voice-module');
        }

        window.onload = function() {
            // 1. Initialize Matrix and Start Loop
            initMatrix(); window.matrixIntervalId = setInterval(drawMatrix, 50);

            // 2. Start Firebase (handles async auth and data logging)
            window.initializeFirebase();

            // 3. Set up Numpad Listeners 
            setupNumpadListeners();
            
            // 4. Initial Data Setup 
            // updateClockAndData(); 
            
            // 5. Start Clock and Data Ticker
            // setInterval(updateClockAndData, 1000); 

            // 6. Generate initial satellite credits (Will sync to cloud)
            // window.getSatelliteCredits();

            if (window.selfAccessGranted) {
                // Defer unlock until Firebase Auth completes (handled in initializeFirebase)
            } else {
                // document.getElementById('pin').innerText = "____";
            }
        };

        window.addEventListener('resize', () => {
            // Re-run init matrix to resize canvas on window change
            if (mc && mctx) { initMatrix(); }
        });

        // --- 8. ANIMATION/CANVAS HELPERS (Full Definitions) ---
        
        let mc, mctx, mcols, my;
        const matrixChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ₳ΩΩΛΔΠ"; 
        const matrixColors = ['#0F0', '#00FF41', '#9D00FF', '#FF00FF', '#00F3FF'];

        function initMatrix() {
            mc = document.getElementById('matrix-layer');
            mctx = mc.getContext('2d');
            mc.width = window.innerWidth; 
            mc.height = window.innerHeight;
            mcols = Math.floor(mc.width/20);
            my = Array(mcols).fill(0);
        }

        function drawMatrix() {
            mctx.fillStyle='rgba(0, 0, 0, 0.08)'; 
            mctx.fillRect(0,0,mc.width,mc.height);
            
            mctx.font='15pt monospace';
            my.forEach((v,i)=>{
                mctx.fillStyle = matrixColors[Math.floor(Math.random() * matrixColors.length)];
                
                let char;
                if (Math.random() > 0.99) { 
                    char = '₳';
                    mctx.fillStyle = '#FF00FF'; 
                } else {
                    char = matrixChars.charAt(Math.floor(Math.random() * matrixChars.length));
                }

                mctx.fillText(char, i*20, v);
                my[i]=v>mc.height && Math.random() > 0.975 ? 0 : v+20;
            });
        }
        
        // Placeholders for Star Map (MAP TAB)
        let sc, sctx, stars = [], mapMode = 'SOLAR';
        function initStars() {
            sc = document.getElementById('star-canvas');
            sctx = sc.getContext('2d');
            const mapContainer = document.getElementById('map-container');
            if (mapContainer && mapContainer.offsetWidth > 0 && mapContainer.offsetHeight > 0) {
                sc.width = mapContainer.offsetWidth;
                sc.height = mapContainer.offsetHeight; 
                stars = [];
                for(let i=0; i<100; i++) {
                    stars.push({x:Math.random()*sc.width, y:Math.random()*sc.height, s:Math.random()*2});
                }
            }
        }
        let animationFrameId;
        function drawMap() {
            sctx.fillStyle='#000'; sctx.fillRect(0,0,sc.width,sc.height);
            sctx.fillStyle='#fff';
            stars.forEach(s => {
                sctx.fillRect(s.x, s.y, s.s, s.s);
                s.x -= 0.2; if(s.x<0) s.x = sc.width;
            });
            
            const cx = sc.width/2; const cy = sc.height/2;
            sctx.strokeStyle='var(--cyan)';
            sctx.beginPath(); sctx.arc(cx, cy, 80, 0, 6.28); sctx.stroke();
            
            sctx.fillStyle = mapMode === 'SOLAR' ? 'var(--cyan)' : 'var(--magenta)';
            sctx.beginPath(); sctx.arc(cx, cy, 5, 0, 6.28); sctx.fill();
            
            animationFrameId = requestAnimationFrame(drawMap);
        }
        function stopMap() { if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } }

        // Placeholder for Singularity (DASHBOARD)
        let singularityCanvas, singularityCtx;
        function initSingularity() {
            singularityCanvas = document.getElementById('singularity-canvas');
            if (singularityCanvas) { singularityCtx = singularityCanvas.getContext('2d'); }
        }
        function drawSingularityCore() {
            if (!singularityCanvas || !singularityCtx) return;
            const sctx = singularityCtx;
            const cw = singularityCanvas.width;
            const ch = singularityCanvas.height;
            sctx.clearRect(0, 0, cw, ch);
            const time = Date.now() * 0.001;
            const center = { x: cw / 2, y: ch / 2 };
            sctx.fillStyle = `rgba(0, 255, 65, ${0.5 + Math.sin(time * 5) * 0.1})`;
            sctx.beginPath();
            sctx.arc(center.x, center.y, 15, 0, Math.PI * 2);
            sctx.fill();
            requestAnimationFrame(drawSingularityCore);
        }
        
    </script>
</body>
</html>

