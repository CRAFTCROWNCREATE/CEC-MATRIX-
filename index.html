<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CEC-BIOMETRIC CORE V5.4 (BHP-09)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tone@14.9.12/build/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inconsolata:wght@400;700&display=swap');
        :root { --neon: #00FF41; --cyan: #00F3FF; --purple: #bc13fe; --red: #FF003C; --bg-dark: #000; }
        body { background: var(--bg-dark); color: var(--neon); font-family: 'Inconsolata', monospace; margin: 0; min-height: 100vh; overflow: hidden; user-select: none; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; }
        .shell-container { max-width: 900px; width: 100%; margin: 0 auto; border: 2px solid var(--neon); box-shadow: 0 0 20px rgba(0, 255, 65, 0.5); background: rgba(0, 5, 0, 0.98); display: flex; flex-direction: column; flex-grow: 1; height: calc(100vh - 30px); position: relative; }
        .header { background: rgba(0, 255, 65, 0.1); padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--neon); font-family: 'Orbitron', sans-serif; font-size: 0.8rem; }
        .status-light { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: var(--neon); box-shadow: 0 0 5px var(--neon); }
        #output-feed { flex-grow: 1; overflow-y: scroll; padding: 15px; font-size: 0.9rem; line-height: 1.5; color: #ccc; white-space: pre-wrap; }
        .prompt { color: var(--neon); font-weight: 700; }
        .system-response { color: var(--cyan); margin-left: 10px; }
        .alert-error { color: var(--red); font-weight: 700; }
        .alert-success { color: var(--purple); font-weight: 700; }
        .log-timestamp { color: #888; font-weight: 400; margin-right: 5px; }
        .input-line { display: flex; border-top: 1px solid var(--neon); padding: 10px 15px; align-items: center; flex-shrink: 0; }
        .input-line span { color: var(--neon); margin-right: 8px; font-weight: 700; }
        #command-input { flex-grow: 1; background: transparent; border: none; outline: none; color: #fff; font-family: 'Inconsolata', monospace; font-size: 0.95rem; caret-color: var(--neon); -webkit-appearance: none; }
        .biometric-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 50; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .biometric-panel { background: #08081a; border: 2px solid var(--purple); box-shadow: 0 0 30px var(--purple); padding: 30px; border-radius: 10px; width: 80%; max-width: 450px; text-align: center; }
        .biometric-panel h2 { color: var(--cyan); font-family: 'Orbitron', sans-serif; }
        .file-upload-btn { background: var(--neon); color: var(--bg-dark); padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; font-weight: 700; transition: background 0.2s; }
        .file-upload-btn:hover { background: #00d437; }
        #loading-spinner { border: 4px solid rgba(0, 255, 65, 0.2); border-top: 4px solid var(--neon); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="shell-container">
    <div class="header">
        <span><span class="status-light status-online" id="status-dot"></span> CEC-CDL AGI MASTER</span>
        <span id="header-status">INITIATING CORE...</span>
        <span id="user-id-display" style="font-size: 0.7rem;">ID: Loading...</span>
    </div>
    <div id="output-feed">
        <span class="system-response">System Initializing... Connecting to Firebase Persistence Layer...</span><br>
    </div>
    <div class="input-line">
        <span id="prompt-prefix">INIT:></span>
        <input type="text" id="command-input" onkeypress="if(event.key === 'Enter') executeCommand()" disabled>
    </div>
    <div id="biometric-modal" class="biometric-modal">
        <div class="biometric-panel">
            <h2 id="biometric-modal-title">BHP-09: BIOMETRIC REGISTRY</h2>
            <p id="biometric-modal-role" style="color: var(--neon); margin-bottom: 15px;"></p>
            <p style="color: #ccc;">Select image for high-security AGI analysis and hash generation.</p>
            <input type="file" id="biometric-file-input" accept="image/*" style="display: none;">
            <button class="file-upload-btn" onclick="document.getElementById('biometric-file-input').click()"> <i class="fas fa-upload"></i> SELECT IMAGE </button>
            <div id="loading-spinner"></div>
            <p id="biometric-status" style="color: var(--cyan); margin-top: 15px;">Awaiting file selection...</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- PASTE YOUR KEYS BELOW ---
    const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE"; 
    
    const firebaseConfig = {
        // PASTE YOUR FIREBASE CONFIG OBJECT HERE (apiKey, authDomain, projectId, etc.)
    };

    const appId = 'cec-live-system-1010'; 
    const CONFIG_DOC_ID = 'master_config';
    let db, auth, userId = 'anonymous';
    let systemState = { agiStatus: "AGI 5.4 LOCKED", wamScore: 92.0, financeAssets: 8472500, commandLog: [], biometricProfiles: [], lastUpdate: Date.now() };
    let currentBiometricRole = null;

    async function playBeep(freq = 440, duration = 0.1) { try { await Tone.start(); const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease(freq, duration); } catch (e) { console.error("Audio error:", e); } }

    function addOutput(text, type = 'system-response') {
        const feed = document.getElementById('output-feed');
        const now = new Date();
        const timestamp = `<span class="log-timestamp">[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]</span>`;
        const outputLine = document.createElement('div');
        outputLine.innerHTML = `${timestamp} <span class="${type}">${text}</span>`;
        feed.appendChild(outputLine);
        feed.scrollTop = feed.scrollHeight;
    }

    function showBiometricModal(role) { currentBiometricRole = role; document.getElementById('biometric-modal-role').innerText = `PROFILE: ${role.toUpperCase()}`; document.getElementById('biometric-modal').style.display = 'flex'; document.getElementById('biometric-file-input').value = ''; document.getElementById('biometric-status').innerText = 'Awaiting file selection...'; document.querySelector('.file-upload-btn').style.display = 'block'; }
    function hideBiometricModal() { document.getElementById('biometric-modal').style.display = 'none'; }

    function setupDataListener() {
        if (!db || !userId) return;
        const docRef = doc(db, 'artifacts', appId, 'users', userId, 'system_state', CONFIG_DOC_ID);
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const loadedState = docSnap.data();
                const initialLoad = systemState.commandLog.length === 0;
                systemState = { ...systemState, ...loadedState };
                if (initialLoad) {
                    addOutput(`[CORE] PERSISTENCE CORE RESTORED. AGI ${systemState.agiStatus} // WAM ${systemState.wamScore.toFixed(1)}`, 'alert-success');
                    systemState.commandLog.forEach(log => { addOutput(`[HISTORY] ${log.cmd}`, 'prompt'); addOutput(log.res, log.type); });
                }
            } else { saveSystemState(true); addOutput("[CORE] NEW INSTANCE DETECTED. INITIAL STATE SAVED.", 'alert-success'); }
            document.getElementById('header-status').innerText = `AGI ${systemState.agiStatus} // WAM ${systemState.wamScore.toFixed(1)}`;
            document.getElementById('status-dot').style.backgroundColor = 'var(--neon)';
        });
    }

    async function saveSystemState(isInitial = false) { if (!db || userId === 'anonymous') return; try { await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'system_state', CONFIG_DOC_ID), systemState); } catch (e) { console.error("Error saving system state:", e); } }

    async function initializeFirebase() {
        if (!firebaseConfig.apiKey) { addOutput("FATAL: FIREBASE CONFIG MISSING IN CODE.", 'alert-error'); return; }
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            await signInAnonymously(auth);
        } catch (error) { console.error("Auth Error:", error); }

        onAuthStateChanged(auth, (user) => {
            if (user) { userId = user.uid; document.getElementById('user-id-display').innerText = `ID: ${userId.substring(0, 8)}...`; setupDataListener(); }
            document.getElementById('command-input').disabled = false;
            document.getElementById('prompt-prefix').innerText = 'CEC-CDL:>';
            document.getElementById('command-input').focus();
        });
    }

    function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); }); }

    async function generateBiometricHash(base64Data, mimeType, role) {
        if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") { throw new Error("API KEY MISSING IN CODE"); }
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ role: "user", parts: [{ text: `Analyze face for role: ${role}. Generate Biometric Signature Hash (BSH).` }, { inlineData: { mimeType: mimeType, data: base64Data } }] }],
            generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "BSH": { "type": "STRING" } } } }
        };
        const response = await fetch(GEMINI_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (response.ok) { const result = await response.json(); return JSON.parse(result.candidates[0].content.parts[0].text).BSH; }
        throw new Error("API Failed");
    }

    document.getElementById('biometric-file-input').addEventListener('change', async (event) => {
        const file = event.target.files[0]; if (!file) return;
        document.getElementById('biometric-status').innerText = `Processing ${file.name}...`; document.querySelector('.file-upload-btn').style.display = 'none'; document.getElementById('loading-spinner').style.display = 'block';
        try {
            const base64Data = await fileToBase64(file);
            const hash = await generateBiometricHash(base64Data, file.type, currentBiometricRole);
            const existingIndex = systemState.biometricProfiles.findIndex(p => p.role.toLowerCase() === currentBiometricRole.toLowerCase());
            if (existingIndex !== -1) { systemState.biometricProfiles[existingIndex].hash = hash; } else { systemState.biometricProfiles.push({ role: currentBiometricRole, hash: hash }); }
            await saveSystemState(); playBeep(800, 0.5); addOutput(`SUCCESS: '${currentBiometricRole.toUpperCase()}' Registered. Hash: ${hash}`, 'alert-success');
        } catch (error) { addOutput(`ERROR: ${error.message}`, 'alert-error'); playBeep(200, 0.2); } finally { hideBiometricModal(); document.getElementById('loading-spinner').style.display = 'none'; document.getElementById('command-input').focus(); }
    });

    window.executeCommand = function() {
        const input = document.getElementById('command-input'); const command = input.value.trim();
        if (!command) return;
        addOutput(`CEC-CDL:> ${command}`, 'prompt'); input.value = ''; playBeep(600, 0.05);
        const lowerCmd = command.toLowerCase();
        let response = "", responseType = 'system-response';

        if (lowerCmd.startsWith('register biometric')) {
            const parts = command.split(/\s+/); const role = parts[2] ? parts[2].toUpperCase() : 'UNKNOWN';
            if (role === 'UNKNOWN') { response = "ERROR: Specify role (e.g., 'MASTER')."; responseType = 'alert-error'; } else { showBiometricModal(role); return; }
        } else if (lowerCmd === 'status') {
            response = `AGI ${systemState.agiStatus} // WAM ${systemState.wamScore}. Assets: $${systemState.financeAssets}. Profiles: ${systemState.biometricProfiles.length}.`; responseType = 'alert-success';
        } else if (lowerCmd.includes('reset system')) {
             systemState.commandLog = []; systemState.biometricProfiles = []; response = "SYSTEM RESET. LOGS WIPED."; responseType = 'alert-error';
        } else { response = "UNKNOWN COMMAND. Try: STATUS, REGISTER BIOMETRIC [ROLE]"; responseType = 'alert-error'; playBeep(200, 0.2); }
        
        systemState.commandLog.push({ cmd: command, res: response, type: responseType });
        if (systemState.commandLog.length > 50) systemState.commandLog = systemState.commandLog.slice(-50);
        addOutput(response, responseType); saveSystemState();
    }

    window.onload = function() { initializeFirebase(); };
</script>
</body>
</html>
